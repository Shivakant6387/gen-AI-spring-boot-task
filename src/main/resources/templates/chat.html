<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>GenAI Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .chat-container { max-width: 600px; margin: 50px auto; background-color: #fff; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); display: flex; flex-direction: column; height: 75vh; overflow: hidden; }
    #chatBox { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background-color: #f9f9f9; white-space: pre-wrap; }
    .message { display: flex; flex-wrap: wrap; align-items: flex-end; }
    .message-user { justify-content: flex-end; }
    .message-ai { justify-content: flex-start; }
    .bubble { padding: 10px 18px; border-radius: 25px; max-width: 70%; word-wrap: break-word; font-size: 0.95rem; position: relative; background-color: #e9ecef; color: #000; }
    .bubble-user { background-color: #0d6efd; color: #fff; border-bottom-right-radius: 0; }
    .time { font-size: 0.7rem; color: #555; margin-left: 8px; }
    .input-group { padding: 10px; border-top: 1px solid #ddd; background-color: #fff; display: flex; gap: 5px; }
    .clear-btn { margin-left: 5px; }
    @media (max-width: 576px) { .chat-container { margin: 20px 10px; height: 80vh; } .bubble { max-width: 90%; } }
    .typing-dots::after { content: '.'; animation: blink 1s steps(1,end) infinite; }
    .typing-dots::before { content: '.'; animation: blink 1s steps(1,end) infinite 0.2s; }
    .typing-dots span { animation: blink 1s steps(1,end) infinite 0.4s; }
    @keyframes blink { 50% { opacity: 0 } }
  </style>
</head>
<body>
<div class="chat-container">
  <div id="chatBox"></div>
  <div class="input-group">
    <input type="text" id="message" class="form-control" placeholder="Type your message..." autofocus>
    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
    <button class="btn btn-danger clear-btn" onclick="chatBox.innerHTML=''">Clear Chat</button>
  </div>
</div>

<script>
  const chatBox = document.getElementById("chatBox");
  const messageInput = document.getElementById("message");

  // Enter key sends message
  messageInput.addEventListener("keydown", function(event) {
    if(event.key === "Enter") { event.preventDefault(); sendMessage(); }
  });

  // Sanitize AI response: convert HTML lists to plain text bullets
  function sanitizeText(text) {
      // Replace <li> with dash bullet, remove all other tags
      return text
          .replace(/<li[^>]*>/gi, '- ')
          .replace(/<\/li>/gi, '\n')
          .replace(/<[^>]+>/g, '') // remove any remaining HTML tags
          .replace(/\r\n|\r|\n/g, '\n'); // normalize new lines
  }

  // Send message function
  async function sendMessage() {
    const message = messageInput.value.trim();
    if(!message) return;

    appendMessage(message, "user");
    messageInput.value = "";

    // Typing indicator
    const typingDiv = appendTyping();

    try {
      const response = await fetch('http://localhost:8082/api/genai/ask', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ prompt: message })
      });

      const data = await response.json();
      chatBox.removeChild(typingDiv);

      // Render AI response as plain text
      appendMessage(sanitizeText(data.answer), "ai");

    } catch (error) {
      console.error(error);
      chatBox.removeChild(typingDiv);
      appendMessage("Error: Could not reach server.", "ai");
    }
  }

  // Append normal message with timestamp
  function appendMessage(text, sender) {
    const div = document.createElement("div");
    div.className = `message message-${sender}`;
    const bubble = document.createElement("div");
    bubble.className = `bubble bubble-${sender}`;
    bubble.textContent = text;

    const timeSpan = document.createElement("span");
    timeSpan.className = "time";
    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    timeSpan.textContent = time;
    bubble.appendChild(timeSpan);

    div.appendChild(bubble);
    chatBox.appendChild(div);
    chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
    return div;
  }

  // Typing animation bubble
  function appendTyping() {
    const div = document.createElement("div");
    div.className = "message message-ai";
    const bubble = document.createElement("div");
    bubble.className = "bubble bubble-ai typing-dots";
    bubble.textContent = 'Typing...';
    div.appendChild(bubble);
    chatBox.appendChild(div);
    chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
    return div;
  }
</script>
</body>
</html>
